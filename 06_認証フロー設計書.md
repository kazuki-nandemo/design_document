# 認証フロー設計書

## プロジェクト: ユーザー管理システム
**作成日**: 2025-11-15
**バージョン**: 1.0

---

## 目次
1. [認証方式概要](#認証方式概要)
2. [JWT Token認証フロー](#jwt-token認証フロー)
3. [Cookie認証フロー](#cookie認証フロー)
4. [トークン仕様](#トークン仕様)
5. [セキュリティ対策](#セキュリティ対策)

---

## 認証方式概要

### 採用方式
本システムでは以下の2つの認証方式をサポート：

1. **JWT Token認証**（推奨）
   - モバイルアプリ、SPA（Single Page Application）向け
   - Stateless（サーバー側でセッション管理不要）
   - スケーラブル

2. **Cookie認証**
   - 従来型Webアプリケーション向け
   - ブラウザが自動的にCookieを送信
   - CSRF対策が必要

---

## JWT Token認証フロー

### 1. ログインフロー

```mermaid
sequenceDiagram
    participant C as クライアント
    participant A as API Server
    participant D as Database

    C->>A: POST /api/v1/auth/login<br/>{email, password}
    A->>D: ユーザー情報取得
    D-->>A: ユーザーデータ
    A->>A: パスワード検証<br/>(bcrypt比較)

    alt 認証成功
        A->>A: Access Token生成<br/>(有効期限: 1時間)
        A->>A: Refresh Token生成<br/>(有効期限: 30日)
        A->>D: Refresh Token保存
        A-->>C: 200 OK<br/>{accessToken, refreshToken, user}
        C->>C: Tokenをローカルストレージに保存
    else 認証失敗
        A-->>C: 401 Unauthorized<br/>{error: "認証に失敗しました"}
    end
```

#### ログインAPIリクエスト
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "email": "taro.yamada@example.com",
  "password": "SecurePass123!"
}
```

#### ログインAPIレスポンス
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 3600,
    "user": {
      "id": "usr_1234567890",
      "firstName": "太郎",
      "lastName": "山田",
      "email": "taro.yamada@example.com"
    }
  }
}
```

---

### 2. 認証付きAPIリクエストフロー

```mermaid
sequenceDiagram
    participant C as クライアント
    participant A as API Server
    participant D as Database

    C->>A: GET /api/v1/users<br/>Authorization: Bearer <accessToken>
    A->>A: Token検証<br/>(署名・有効期限チェック)

    alt Token有効
        A->>A: Tokenからユーザー情報抽出
        A->>D: データ取得
        D-->>A: データ
        A-->>C: 200 OK<br/>{data}
    else Token無効/期限切れ
        A-->>C: 401 Unauthorized<br/>{error: "認証が必要です"}
    end
```

#### 認証付きリクエスト例
```http
GET /api/v1/users
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

---

### 3. トークンリフレッシュフロー

```mermaid
sequenceDiagram
    participant C as クライアント
    participant A as API Server
    participant D as Database

    C->>A: POST /api/v1/auth/refresh<br/>{refreshToken}
    A->>A: Refresh Token検証
    A->>D: Refresh Token存在確認
    D-->>A: Token情報

    alt Token有効
        A->>A: 新しいAccess Token生成
        A->>A: 新しいRefresh Token生成（オプション）
        A->>D: 新しいRefresh Token保存<br/>古いTokenは無効化
        A-->>C: 200 OK<br/>{accessToken, refreshToken}
        C->>C: Tokenを更新
    else Token無効
        A->>D: Tokenを無効化
        A-->>C: 401 Unauthorized<br/>{error: "再ログインが必要です"}
        C->>C: ログイン画面へリダイレクト
    end
```

#### トークンリフレッシュAPIリクエスト
```http
POST /api/v1/auth/refresh
Content-Type: application/json

{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### トークンリフレッシュAPIレスポンス
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 3600
  }
}
```

---

### 4. ログアウトフロー

```mermaid
sequenceDiagram
    participant C as クライアント
    participant A as API Server
    participant D as Database

    C->>A: POST /api/v1/auth/logout<br/>Authorization: Bearer <accessToken><br/>{refreshToken}
    A->>A: Access Token検証
    A->>D: Refresh Token無効化
    D-->>A: 完了
    A-->>C: 200 OK<br/>{message: "ログアウトしました"}
    C->>C: ローカルストレージから<br/>Token削除
    C->>C: ログイン画面へリダイレクト
```

---

## Cookie認証フロー

### 1. ログインフロー（Cookie版）

```mermaid
sequenceDiagram
    participant B as ブラウザ
    participant A as API Server
    participant D as Database

    B->>A: POST /api/v1/auth/login<br/>{email, password, rememberMe}
    A->>D: ユーザー情報取得
    D-->>A: ユーザーデータ
    A->>A: パスワード検証

    alt 認証成功
        A->>A: セッションID生成
        A->>D: セッション保存<br/>(Redis/DB)
        A-->>B: 200 OK<br/>Set-Cookie: sessionId=...<br/>{user}
        Note over B: ブラウザがCookieを自動保存
    else 認証失敗
        A-->>B: 401 Unauthorized
    end
```

#### Cookie設定例
```http
Set-Cookie: sessionId=abc123xyz789;
  HttpOnly;
  Secure;
  SameSite=Strict;
  Max-Age=86400;
  Path=/
```

---

### 2. 認証付きリクエスト（Cookie版）

```mermaid
sequenceDiagram
    participant B as ブラウザ
    participant A as API Server
    participant R as Redis/Session Store

    Note over B: ブラウザがCookieを自動送信
    B->>A: GET /api/v1/users<br/>Cookie: sessionId=abc123xyz789
    A->>R: セッション情報取得
    R-->>A: セッションデータ

    alt セッション有効
        A->>A: セッションからユーザー情報抽出
        A-->>B: 200 OK<br/>{data}
    else セッション無効/期限切れ
        A-->>B: 401 Unauthorized
    end
```

---

### 3. ログアウト（Cookie版）

```mermaid
sequenceDiagram
    participant B as ブラウザ
    participant A as API Server
    participant R as Redis/Session Store

    B->>A: POST /api/v1/auth/logout<br/>Cookie: sessionId=abc123xyz789
    A->>R: セッション削除
    R-->>A: 完了
    A-->>B: 200 OK<br/>Set-Cookie: sessionId=; Max-Age=0
    Note over B: ブラウザがCookieを削除
```

---

## トークン仕様

### JWT Access Token

#### ペイロード構造
```json
{
  "sub": "usr_1234567890",
  "email": "taro.yamada@example.com",
  "role": "user",
  "iat": 1700000000,
  "exp": 1700003600,
  "iss": "https://api.example.com",
  "aud": "https://example.com"
}
```

#### フィールド説明
| フィールド | 説明 | 例 |
|-----------|------|-----|
| sub | Subject（ユーザーID） | usr_1234567890 |
| email | メールアドレス | taro.yamada@example.com |
| role | ユーザーロール | user / admin |
| iat | Issued At（発行日時） | 1700000000 (Unix timestamp) |
| exp | Expiration（有効期限） | 1700003600 (Unix timestamp) |
| iss | Issuer（発行者） | https://api.example.com |
| aud | Audience（対象） | https://example.com |

#### 署名アルゴリズム
- **アルゴリズム**: HS256 (HMAC + SHA256)
- **秘密鍵**: 環境変数 `JWT_SECRET` で管理（256bit以上）
- **代替案**: RS256（公開鍵暗号方式）でマイクロサービス間連携時に使用

---

### JWT Refresh Token

#### ペイロード構造
```json
{
  "sub": "usr_1234567890",
  "type": "refresh",
  "jti": "rtk_abc123xyz789",
  "iat": 1700000000,
  "exp": 1702592000,
  "iss": "https://api.example.com"
}
```

#### フィールド説明
| フィールド | 説明 | 例 |
|-----------|------|-----|
| sub | Subject（ユーザーID） | usr_1234567890 |
| type | トークンタイプ | refresh |
| jti | JWT ID（トークン識別子） | rtk_abc123xyz789 |
| iat | 発行日時 | 1700000000 |
| exp | 有効期限（30日後） | 1702592000 |
| iss | 発行者 | https://api.example.com |

---

### トークン有効期限

| トークン種別 | 有効期限 | 更新タイミング | 保存場所 |
|------------|---------|--------------|---------|
| Access Token | 1時間 | Refresh Token使用時 | メモリ/LocalStorage |
| Refresh Token | 30日 | ログイン時/リフレッシュ時 | LocalStorage（暗号化推奨） |
| Session Cookie | 1日（rememberMe: 30日） | ログイン時 | Cookie (HttpOnly) |

---

## セキュリティ対策

### 1. パスワード管理
- **ハッシュアルゴリズム**: bcrypt（cost factor: 12）
- **ソルト**: bcryptが自動生成
- **パスワード要件**: 8文字以上、英大文字・小文字・数字・記号を含む
- **パスワード履歴**: 過去3世代のパスワードは再利用不可

### 2. トークンセキュリティ

#### JWT Token
- **秘密鍵管理**: 環境変数で管理、定期的にローテーション
- **XSS対策**: LocalStorageではなくメモリ保存を推奨
- **HTTPS必須**: 本番環境では必ずHTTPSを使用
- **トークン無効化**: ブラックリスト方式でログアウト時に無効化

#### Cookie
- **HttpOnly**: JavaScriptからのアクセス不可
- **Secure**: HTTPS通信のみ
- **SameSite**: Strict（CSRF対策）
- **有効期限**: Max-Ageで明示的に設定

### 3. CSRF対策（Cookie認証時）
- **CSRFトークン**: 各フォームに一意のトークンを埋め込み
- **SameSite属性**: Cookie設定でSameSite=Strictを使用
- **カスタムヘッダー**: X-CSRF-Tokenヘッダーでトークンを送信

### 4. ブルートフォース攻撃対策
- **レート制限**:
  - ログイン試行: 5回/5分（IPアドレス単位）
  - パスワードリセット: 3回/時間（メールアドレス単位）
- **アカウントロック**:
  - 10回連続失敗で30分間ロック
  - 管理者による手動解除可能
- **CAPTCHA**: 3回失敗後にCAPTCHA表示

### 5. セッション管理
- **セッションストア**: Redis（高速・揮発性）
- **セッション固定攻撃対策**: ログイン時にセッションIDを再生成
- **同時セッション制限**: 1ユーザーあたり最大5セッション
- **異常検知**:
  - IPアドレスの急激な変化を検知
  - User-Agentの変化を検知

### 6. 多要素認証（MFA）
- **実装方式**: TOTP（Time-based One-Time Password）
- **対応アプリ**: Google Authenticator、Authy等
- **バックアップコード**: 10個の使い捨てコードを発行
- **適用範囲**: 管理者は必須、一般ユーザーは任意

---

## エンドポイント一覧

| メソッド | エンドポイント | 説明 | 認証 |
|---------|--------------|------|------|
| POST | /api/v1/auth/login | ログイン | 不要 |
| POST | /api/v1/auth/logout | ログアウト | 必要 |
| POST | /api/v1/auth/refresh | トークンリフレッシュ | 不要 |
| POST | /api/v1/auth/register | ユーザー登録 | 不要 |
| POST | /api/v1/auth/password-reset | パスワードリセット要求 | 不要 |
| POST | /api/v1/auth/password-reset/confirm | パスワードリセット実行 | 不要 |
| POST | /api/v1/auth/password-change | パスワード変更 | 必要 |
| GET | /api/v1/auth/me | 現在のユーザー情報取得 | 必要 |
| POST | /api/v1/auth/mfa/enable | MFA有効化 | 必要 |
| POST | /api/v1/auth/mfa/verify | MFA検証 | 必要 |

---

## エラーハンドリング

### 認証エラーコード

| コード | HTTPステータス | 説明 | 対処方法 |
|-------|---------------|------|---------|
| INVALID_CREDENTIALS | 401 | メールアドレスまたはパスワードが間違い | 再入力 |
| TOKEN_EXPIRED | 401 | トークンの有効期限切れ | リフレッシュ |
| TOKEN_INVALID | 401 | トークンが無効 | 再ログイン |
| SESSION_EXPIRED | 401 | セッションの有効期限切れ | 再ログイン |
| ACCOUNT_LOCKED | 403 | アカウントがロック中 | 時間経過後に再試行 |
| MFA_REQUIRED | 403 | MFA認証が必要 | MFAコード入力 |
| MFA_INVALID | 401 | MFAコードが無効 | 再入力 |

---

## 実装チェックリスト

### 必須項目
- [ ] JWT Access Token / Refresh Tokenの生成・検証
- [ ] bcryptによるパスワードハッシュ化
- [ ] HTTPS通信の強制
- [ ] レート制限の実装
- [ ] セッション管理（Cookie認証時）
- [ ] CSRF対策（Cookie認証時）
- [ ] XSS対策（入力サニタイゼーション）
- [ ] パスワードポリシーの実装

### 推奨項目
- [ ] MFA（多要素認証）の実装
- [ ] アカウントロック機能
- [ ] 異常ログイン検知
- [ ] セキュリティログの記録
- [ ] パスワード履歴管理
- [ ] トークンローテーション

---

## 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|------------|------|--------|----------|
| 1.0 | 2025-11-15 | 設計チーム | 初版作成 |
