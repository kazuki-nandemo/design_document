# テーブル定義書

**プロジェクト**: ユーザー管理システム
**作成日**: 2025-11-15
**DBMS**: PostgreSQL 15.x

---

## テーブル一覧

| テーブル名 | 説明 | 想定レコード数 |
|-----------|------|--------------|
| users | ユーザーの基本情報・認証情報 | 100万件 |
| user_profiles | ユーザーの詳細プロフィール | 100万件 |
| user_sessions | ログインセッション・トークン管理 | 500万件 |

---

## 1. users（ユーザー）

### テーブル概要
- **テーブル名**: users
- **論理名**: ユーザー
- **説明**: ユーザーの基本情報および認証情報を管理
- **主キー**: id
- **文字コード**: UTF-8
- **照合順序**: utf8mb4_general_ci

### カラム定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | VARCHAR(50) | × | - | ユーザーID（PK）プレフィックス: usr_ |
| email | VARCHAR(254) | × | - | メールアドレス（UNIQUE、ログインID） |
| password_hash | VARCHAR(255) | × | - | bcryptハッシュ値（cost factor: 12） |
| first_name | VARCHAR(50) | × | - | 名 |
| last_name | VARCHAR(50) | × | - | 姓 |
| birth_date | DATE | × | - | 生年月日 |
| gender | VARCHAR(20) | ○ | NULL | 性別（male/female/other/prefer_not_to_say） |
| status | VARCHAR(20) | × | 'active' | ステータス（active/inactive） |
| role | VARCHAR(20) | × | 'user' | ロール（user/admin） |
| email_verified | BOOLEAN | × | FALSE | メール認証済みフラグ |
| email_verified_at | TIMESTAMP | ○ | NULL | メール認証日時 |
| last_login_at | TIMESTAMP | ○ | NULL | 最終ログイン日時 |
| login_count | INTEGER | × | 0 | 累計ログイン回数 |
| failed_login_attempts | INTEGER | × | 0 | 連続ログイン失敗回数（成功時リセット） |
| locked_until | TIMESTAMP | ○ | NULL | アカウントロック解除日時 |
| created_at | TIMESTAMP | × | CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | × | CURRENT_TIMESTAMP | レコード更新日時（自動更新） |
| deleted_at | TIMESTAMP | ○ | NULL | 論理削除日時 |

### 制約

#### PRIMARY KEY
```sql
CONSTRAINT pk_users PRIMARY KEY (id)
```

#### UNIQUE KEY
```sql
CONSTRAINT uk_users_email UNIQUE (email)
```

#### CHECK制約
```sql
CONSTRAINT chk_users_status CHECK (status IN ('active', 'inactive')),
CONSTRAINT chk_users_role CHECK (role IN ('user', 'admin')),
CONSTRAINT chk_users_gender CHECK (gender IN ('male', 'female', 'other', 'prefer_not_to_say')),
CONSTRAINT chk_users_email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
```

### インデックス
```sql
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_users_deleted_at ON users(deleted_at);
```

### DDL
```sql
CREATE TABLE users (
    id VARCHAR(50) NOT NULL,
    email VARCHAR(254) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    birth_date DATE NOT NULL,
    gender VARCHAR(20),
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    email_verified BOOLEAN NOT NULL DEFAULT FALSE,
    email_verified_at TIMESTAMP,
    last_login_at TIMESTAMP,
    login_count INTEGER NOT NULL DEFAULT 0,
    failed_login_attempts INTEGER NOT NULL DEFAULT 0,
    locked_until TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    CONSTRAINT pk_users PRIMARY KEY (id),
    CONSTRAINT uk_users_email UNIQUE (email),
    CONSTRAINT chk_users_status CHECK (status IN ('active', 'inactive')),
    CONSTRAINT chk_users_role CHECK (role IN ('user', 'admin')),
    CONSTRAINT chk_users_gender CHECK (gender IN ('male', 'female', 'other', 'prefer_not_to_say'))
);

-- インデックス作成
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_users_deleted_at ON users(deleted_at);

-- 更新日時自動更新トリガー
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER trigger_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

---

## 2. user_profiles（ユーザープロフィール）

### テーブル概要
- **テーブル名**: user_profiles
- **論理名**: ユーザープロフィール
- **説明**: ユーザーの詳細プロフィール情報
- **主キー**: id
- **外部キー**: user_id (users.id)

### カラム定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | VARCHAR(50) | × | - | プロフィールID（PK）プレフィックス: prf_ |
| user_id | VARCHAR(50) | × | - | ユーザーID（FK, UNIQUE） |
| profile_image_url | TEXT | ○ | NULL | プロフィール画像URL（S3等） |
| bio | TEXT | ○ | NULL | 自己紹介文（最大1000文字） |
| phone_number | VARCHAR(20) | ○ | NULL | 電話番号 |
| address_postal_code | VARCHAR(10) | ○ | NULL | 郵便番号 |
| address_prefecture | VARCHAR(10) | ○ | NULL | 都道府県 |
| address_city | VARCHAR(50) | ○ | NULL | 市区町村 |
| address_street | VARCHAR(100) | ○ | NULL | 番地・建物名 |
| website_url | TEXT | ○ | NULL | ウェブサイトURL |
| twitter_handle | VARCHAR(50) | ○ | NULL | Twitterハンドル（@なし） |
| locale | VARCHAR(10) | × | 'ja_JP' | 言語設定（ja_JP/en_US等） |
| timezone | VARCHAR(50) | × | 'Asia/Tokyo' | タイムゾーン（IANA形式） |
| created_at | TIMESTAMP | × | CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | × | CURRENT_TIMESTAMP | レコード更新日時（自動更新） |

### 制約

#### PRIMARY KEY
```sql
CONSTRAINT pk_user_profiles PRIMARY KEY (id)
```

#### FOREIGN KEY
```sql
CONSTRAINT fk_user_profiles_user_id FOREIGN KEY (user_id)
    REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE
```

#### UNIQUE KEY
```sql
CONSTRAINT uk_user_profiles_user_id UNIQUE (user_id)
```

### インデックス
```sql
CREATE UNIQUE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
```

### DDL
```sql
CREATE TABLE user_profiles (
    id VARCHAR(50) NOT NULL,
    user_id VARCHAR(50) NOT NULL,
    profile_image_url TEXT,
    bio TEXT,
    phone_number VARCHAR(20),
    address_postal_code VARCHAR(10),
    address_prefecture VARCHAR(10),
    address_city VARCHAR(50),
    address_street VARCHAR(100),
    website_url TEXT,
    twitter_handle VARCHAR(50),
    locale VARCHAR(10) NOT NULL DEFAULT 'ja_JP',
    timezone VARCHAR(50) NOT NULL DEFAULT 'Asia/Tokyo',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT pk_user_profiles PRIMARY KEY (id),
    CONSTRAINT fk_user_profiles_user_id FOREIGN KEY (user_id)
        REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT uk_user_profiles_user_id UNIQUE (user_id)
);

-- インデックス作成
CREATE UNIQUE INDEX idx_user_profiles_user_id ON user_profiles(user_id);

-- 更新日時自動更新トリガー
CREATE TRIGGER trigger_user_profiles_updated_at
BEFORE UPDATE ON user_profiles
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

---

## 3. user_sessions（ユーザーセッション）

### テーブル概要
- **テーブル名**: user_sessions
- **論理名**: ユーザーセッション
- **説明**: ユーザーのログインセッション・トークン管理
- **主キー**: id
- **外部キー**: user_id (users.id)

### カラム定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | VARCHAR(50) | × | - | セッションID（PK）プレフィックス: ses_ |
| user_id | VARCHAR(50) | × | - | ユーザーID（FK） |
| refresh_token | TEXT | × | - | JWTリフレッシュトークン |
| refresh_token_hash | VARCHAR(255) | × | - | トークンのハッシュ値（SHA256） |
| device_type | VARCHAR(20) | ○ | NULL | デバイス種別（mobile/tablet/desktop） |
| device_name | VARCHAR(100) | ○ | NULL | デバイス名（例: iPhone 14 Pro） |
| browser | VARCHAR(50) | ○ | NULL | ブラウザ名（Chrome, Safari等） |
| browser_version | VARCHAR(20) | ○ | NULL | ブラウザバージョン（例: 119.0.0） |
| os | VARCHAR(50) | ○ | NULL | OS名（iOS, Android, Windows等） |
| os_version | VARCHAR(20) | ○ | NULL | OSバージョン（例: 17.1） |
| ip_address | VARCHAR(45) | ○ | NULL | IPアドレス（IPv6対応） |
| user_agent | TEXT | ○ | NULL | User-Agent文字列 |
| is_active | BOOLEAN | × | TRUE | セッション有効フラグ |
| expires_at | TIMESTAMP | × | - | トークン有効期限 |
| last_accessed_at | TIMESTAMP | × | CURRENT_TIMESTAMP | 最終アクセス日時（自動更新） |
| created_at | TIMESTAMP | × | CURRENT_TIMESTAMP | レコード作成日時 |
| revoked_at | TIMESTAMP | ○ | NULL | トークン無効化日時（ログアウト時） |

### 制約

#### PRIMARY KEY
```sql
CONSTRAINT pk_user_sessions PRIMARY KEY (id)
```

#### FOREIGN KEY
```sql
CONSTRAINT fk_user_sessions_user_id FOREIGN KEY (user_id)
    REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE
```

### インデックス
```sql
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_refresh_token_hash ON user_sessions(refresh_token_hash);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
CREATE INDEX idx_user_sessions_is_active ON user_sessions(is_active);
CREATE INDEX idx_user_sessions_created_at ON user_sessions(created_at);
```

### DDL
```sql
CREATE TABLE user_sessions (
    id VARCHAR(50) NOT NULL,
    user_id VARCHAR(50) NOT NULL,
    refresh_token TEXT NOT NULL,
    refresh_token_hash VARCHAR(255) NOT NULL,
    device_type VARCHAR(20),
    device_name VARCHAR(100),
    browser VARCHAR(50),
    browser_version VARCHAR(20),
    os VARCHAR(50),
    os_version VARCHAR(20),
    ip_address VARCHAR(45),
    user_agent TEXT,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    expires_at TIMESTAMP NOT NULL,
    last_accessed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    revoked_at TIMESTAMP,
    CONSTRAINT pk_user_sessions PRIMARY KEY (id),
    CONSTRAINT fk_user_sessions_user_id FOREIGN KEY (user_id)
        REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE
);

-- インデックス作成
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_refresh_token_hash ON user_sessions(refresh_token_hash);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
CREATE INDEX idx_user_sessions_is_active ON user_sessions(is_active);
CREATE INDEX idx_user_sessions_created_at ON user_sessions(created_at);

-- 期限切れセッション自動削除（バッチ処理で実行）
-- DELETE FROM user_sessions WHERE expires_at < CURRENT_TIMESTAMP AND is_active = FALSE;
```

---

## 共通仕様

### 命名規則
- **テーブル名**: 小文字スネークケース、複数形（users, user_profiles）
- **カラム名**: 小文字スネークケース（first_name, created_at）
- **主キー**: id
- **外部キー**: {参照先テーブル名（単数形）}_id
- **日時カラム**: created_at, updated_at, deleted_at
- **論理削除**: deleted_at（NULLで有効、値ありで削除済み）

### データ型
- **ID**: VARCHAR(50) - UUID v4またはプレフィックス付きID
- **文字列**: VARCHAR(n) - 長さ制限あり
- **長文**: TEXT - 長さ制限なし
- **日時**: TIMESTAMP - タイムゾーン付き
- **日付**: DATE
- **数値**: INTEGER, BIGINT
- **真偽値**: BOOLEAN
- **金額**: DECIMAL(10,2) - 必要に応じて使用

### 論理削除
- deleted_atカラムで管理
- NULLの場合は有効、値が入っている場合は削除済み
- 削除済みレコードも物理削除せずに保持

### タイムスタンプ
- **created_at**: レコード作成時に自動設定（CURRENT_TIMESTAMP）
- **updated_at**: レコード更新時に自動更新（トリガーで実装）
- **deleted_at**: 論理削除時に設定

---

## インデックス戦略

### インデックス作成基準
1. **PRIMARY KEY**: すべてのテーブルに必須
2. **FOREIGN KEY**: 外部キーには必ずインデックス作成
3. **UNIQUE KEY**: 一意制約が必要なカラム（email等）
4. **検索条件**: WHERE句で頻繁に使用するカラム
5. **ソート条件**: ORDER BY句で使用するカラム
6. **複合インデックス**: 複数カラムでの検索が多い場合

### パフォーマンス考慮事項
- インデックスは書き込み性能を低下させるため、必要最小限に
- カーディナリティの高いカラムを優先
- 複合インデックスは選択性の高いカラムを左側に配置

---

## バックアップ・運用

### バックアップ戦略
- **フルバックアップ**: 毎日深夜3時（UTC）
- **差分バックアップ**: 6時間ごと
- **保持期間**: 30日間
- **バックアップ先**: AWS S3（暗号化）

### データ保守
- **期限切れセッション削除**: 毎日（expires_at < 現在時刻）
- **論理削除レコード物理削除**: 6ヶ月経過後
- **統計情報更新**: 毎週日曜日

---

## メモ

- IDは全部プレフィックス付き（usr_, prf_, ses_）でわかりやすく
- パスワードはbcryptでハッシュ化（cost factor 12）
- セッションは有効期限切れたら定期的に削除する（バッチ処理で）
- 論理削除で運用（deleted_atがNULLなら有効）
- インデックスは必要最小限に（書き込み性能も考慮）
- updated_atはトリガーで自動更新するから手動更新不要
